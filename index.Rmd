---
title: "Boulder BrainTrust<sup>TM</sup> cookbook for R graphics"
author: "cfelletter"
date: "Last updated: `r format(Sys.Date())`"
output: 
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    theme: cosmo
---
```{r setup, include=FALSE, echo=TRUE, warning=FALSE}
if(!require(pacman))install.packages("pacman")
pacman::p_load('tidyverse', 'devtools', 'RWDataPlyr',
               'scales')
options(scipen = 999)
```

## How to create Boulder BrainTrust<sup>TM</sup> style graphics

We have developed an R cookbook to make the process of creating publication-ready graphics in our in-house style using R's ggplot2 library a more reproducible process, as well as making it easier for people new to R to create graphics. This was developed from BBC Visual Journalism data team's R graphics cookbook. For more info on the cookbook and `bbplot` check out the [package's Github repo](https://github.com/bbc/bbplot).  

We'll get to how you can put together the various elements of these graphics, but **let's get the admin out of the way first...**

### Load all the libraries you need

A few of the steps in this cookbook - and to create charts in R in general - require certain packages to be installed and loaded. So that you do not have to install and load them one by one, you can use the `p_load` function in the `pacman` package to load them all at once with the following code. 

```{r eval=FALSE}
#This line of code installs the pacman page if you do not have it installed - if you do, it simply loads the package
if(!require(pacman))install.packages("pacman")
pacman::p_load('tidyverse', 'devtools', 'RWDataPlyr',
               'scales')
```

### RWDataPlyr

#### Overview

RWDataPlyr is a tool to read and manipulate data generated from [RiverWare<sup>TM</sup>](http://www.riverware.org) simulations in rdf, csv, and nc formats and work with those data in a dplyr pipeline. It provides functions to gather,  aggregate, and summarize data from multiple RiverWare simulations, i.e., scenarios.

#### Installation

RWDataPlyr can be installed from CRAN:

```{r, eval = FALSE}
install.packages("RWDataPlyr")
```

Or the development version can be installed from GitHub:

```{r, eval=FALSE}
# install.packages("devtools")
devtools::install_github("BoulderCodeHub/RWDataPlyr")
```

#### How does RWDataPlyr work?

RWDataPlyr provides at least three workflows for reading and using RiverWare data:

1. Reading and manipulating a single scenario
    * Fast
    * Best for inspecting a single slot
    * If comparing scenarios, must manually repeat for each scenario
    * Relies on `read_rdf()` and `read_rw_csv()`
2. Summarizing multiple slots of data from a single scenario
    * Repeatable; allows user to process many slots at once
    * Best for producing "polished" analyses of a single scenario
    * Relies on `rdf_aggregate()` and user specified `rwd_agg` object
3. Aggregating and summarizing many scenarios
    * Repeatable; allows user to process many slots for many scenarios at once
    * Repeats summary of a single scenario on multiple scenarios and combines results together
    * Relies on `rw_scen_aggregate()` and user specified `rwd_agg` object

Check out the workflow vignette for more details:

```{r, eval = FALSE}
vignette("rwdataplyr-workflow", package = "RWDataPlyr")
```


The code below shows how data from `rw_scen_aggregate()` and user specified `rwd_agg` can be used within standard chart-production workflow. In this is example monthly data from the `RWDataPlyr` package has already been aggregated to an annual EOCY value. The example creates a boxplot of the EOCY values to compare two scenarios.   

```{r message = FALSE, warning = FALSE}
#Load required scripts to create the custom plot types 
source('code/Stat_emp_ExcCrv.r')
source('code/stat-boxplot-custom.r')

#Data for chart from RWDataPlyr package
scen_res <- RWDataPlyr::scen_data

#Specify variables for chart and data minipulation
variable <- "peEocy"
y_lab <- "EOCY Pool Elevation (ft)"
title <- "EOCY Pool Elevation (ft)"
startyr <- 2018
endyr <- 2022
caption <- "Note: The boxplots show the distribution of traces, one for each year. The boxplot boxes correspond to the 25th and 75th quantiles,\nthe whiskers enclose the 10th to 90th quantiles,with points representing data that falls outside this range."

#minipulate data 
df <- scen_res %>%
  dplyr::filter(Variable == variable) %>%
  dplyr::filter(startyr <= Year && Year <= endyr) %>% #filter year
  dplyr::group_by(Scenario, Year) 

#plot data 
p <- df %>%
  ggplot(aes(x = factor(Year), y = Value, color = Scenario)) +
  stat_boxplot_custom(qs = c(0.1, 0.25, 0.5, 0.75, 0.9)) +
  labs(title = paste(variable,startyr,"-",endyr),
       y = y_lab, x = "Year", caption = caption) +
  theme(plot.caption = element_text(hjust = 0)) #left justify

#print graph 
print(p)
```

## How to plots means of all traces

*The developer regrets to inform you...*  

## How to plot a histogram of trace values

*that unfortunately this project was not funded.*  

## How to plot exceedances of all traces 

*I'm afraid your on your own.*  

## How to get trace min/max

*It's a cold dark stackoverflow out there...*  

## How find and plot the max diff trace of two scenarios 


